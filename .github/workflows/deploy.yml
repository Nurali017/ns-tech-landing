name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: kaysar.kz
          username: debian
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            APP_DIR="/home/debian/ns-tech-landing"

            # Clone or pull latest code
            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/Nurali017/ns-tech-landing.git "$APP_DIR"
            fi

            cd "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main

            # Build Docker image
            docker build -t ns-tech-landing:latest .

            # Stop and remove old container if exists
            docker stop ns-tech-landing 2>/dev/null || true
            docker rm ns-tech-landing 2>/dev/null || true

            # Run new container on kaisar network
            docker run -d \
              --name ns-tech-landing \
              --network kaisar_kaisar-network \
              --restart unless-stopped \
              ns-tech-landing:latest

            # Reload nginx to pick up any config changes
            docker exec kaisar-nginx nginx -s reload 2>/dev/null || true

            echo "Deploy complete!"
