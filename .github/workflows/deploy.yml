name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: kaysar.kz
          username: debian
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            APP_DIR="/home/debian/ns-tech-landing"

            if [ ! -d "$APP_DIR" ]; then
              git clone https://github.com/Nurali017/ns-tech-landing.git "$APP_DIR"
            fi

            cd "$APP_DIR"
            git fetch origin main
            git reset --hard origin/main

            npm ci --production=false
            npm run build

            cp -r public .next/standalone/public
            cp -r .next/static .next/standalone/.next/static

            pm2 describe ns-tech-landing > /dev/null 2>&1 && \
              pm2 restart ns-tech-landing || \
              pm2 start .next/standalone/server.js \
                --name ns-tech-landing \
                --env PORT=3001 \
                -- -H 0.0.0.0

            pm2 save
